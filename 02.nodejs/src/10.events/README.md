## Node 底层事件模型

Node 本身能够做到如此高性能的根本原因在于 **事件（event）** 的使用，
以及对于 **事件监听者（listener，callback）** 的调用上。

> Node 本身是基于事件循环机制的。

本质上，当 Node 启动一个文件或者服务后，Node 实际上是运行在一个死循环中的。

```javascript
while(true) {
	...
}
```

在这个死循环中，**Node 会不断发射事件** 、**监听事件** 并且 **执行回调逻辑**。

事件来源主要有两种：<em>一是 Node 自身所发射出的事件</em>，<em>二是来自于 Node 自身所运行的环境</em>。（文件读取、http 服务）

**监听事件：回调都是要依附于相应的事件的** 。

**执行回调逻辑：本质上都是由底层来执行的**。

## Node 异步操作

关于 IO 操作的一步执行逻辑：

1. 同步模式
2. 异步模式：`poll` `epoll` windows 上`IOCP`，linux上系统库 `libuv`

Node 的单线程：所谓单线程，指的是 **Node 的逻辑执行主线程是单线程的**，即 JavaScript 代码运行所处的线程，这个是单线程，因为 JavaScript 本身只能执行在单线程当中。

```text
      ------          -----       ------
---→ 丨    丨     ---→丨   丨 ---→ 丨    丨  主线程是单线程
      ------          -----       ------
        ↓               ↓            
      -----           ------ 
     丨////丨         丨////丨     异步操作的系统调用，资源读取，网络操作（在线程池中操作） 
      -----           ------
```

当我们在程序中引入了某个第三方模块时，那么整体的全部执行逻辑如下所示：

```text
Node → 第三方模块 → 原生模块 → 原生模块内部的实现（internal） → C++ 模块 → libuv/IOCP → 线程池 → 线程 → 执行底层的IO操作（涉及到操作系统调用）
```

当 Node 在执行过程中，它会判断当前的操作系统类型

Node 完整的事件循环逻辑：

1. 启动 Node 运行时
2. 检测是否有待处理的事件
3. 如果没有，回到循环开始
4. 如果有，那么从事件队列中取出一个事件
5. 判断当前这个事件有没有与之关联的事件处理器（回调）
6. 如果没有，回到循环开始
7. 如果有，则执事件行的回调逻辑
8. 回到循环开始，开始新一轮的事件检测流程

```text
           ------------→   启动 Node 运行时  ←-----------
          ↑                     ↓                      ↑
          ↑               检测是否有待处理的事件 ----No----
          ↑                     ↓
          ↑              从事件队列中取出一个事件  
          ↑                     ↓
          --No--判断当前这个事件有没有与之关联的事件处理器（回调）
                                ↓
                          执事件行的回调逻辑
                                ↓
                  回到循环开始，开始新一轮的事件检测流程
```

> 整个 Node 的执行过程实际上是由：**完整的事件循环机制** + **底层的操作系统异步 IO 调用** + **线程池**（底层库实现或由操作系统提供）共同配合来完成的。

对于传统服务器，来一个请求启动一个线程，请求完毕把线程放回线程池中，整个程序执行流程很好理解。但是也有限制：

1. 线程本身是有操作系统创建的，线程本身是占用资源的，对于操作系统所能创建的线程是有限的。
2. 线程是在 CPU 调度下执行，如果系统中线程数过多，那么线程上下文在 CPU 中频繁的切换，消耗 CPU 资源。

对于单线程的 Node 来说，是否无法利用到多核的优势呢？

对于 Node 主线程来说，它只能运行在一个核心上面。

对于底层的线程池来说，他们却可以运行在多个核心上面，当然也可以同时运行，因此他们是完全可以利用到多核优势的。



